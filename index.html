<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CozySwap — Advanced Auto Trading</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.umd.min.js"></script>
<style>
  :root{--bg:#0b0b0f;--card:#111216;--muted:#9aa0a6;--accent1:#6c63ff;--accent2:#00c6ff}
  body{background:var(--bg);color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,0.03)}
  .muted{color:var(--muted)}
  .small{font-size:13px}
  .btn-grad{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white}
  .rounded-full-img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  a.tx-link{color:#66b2ff;text-decoration:underline;cursor:pointer}
  .auto-buy{background:linear-gradient(90deg,#10b981,#059669)}
  .auto-sell{background:linear-gradient(90deg,#ef4444,#dc2626)}
  .wallet-active{background:linear-gradient(90deg,#3b82f6,#1d4ed8)}
  .status-running{color:#10b981}
  .status-stopped{color:#ef4444}
  .status-warning{color:#f59e0b}
  .checkbox-custom{appearance:none;width:18px;height:18px;border:2px solid #4b5563;border-radius:4px;background:transparent;cursor:pointer;position:relative}
  .checkbox-custom:checked{background:#3b82f6;border-color:#3b82f6}
  .checkbox-custom:checked:after{content:'✓';color:white;position:absolute;left:2px;top:-1px;font-size:12px}
</style>
</head>
<body class="p-4">
  <div class="max-w-7xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <img src="https://photos.pinksale.finance/file/pinksale-logo-upload/1759992605150-e3175ba3ea1d9672e44128a60a685807.JPG" class="rounded-full-img" alt="Cozy"/>
        <div>
          <div class="text-2xl font-semibold">CozySwap — Advanced Auto Trading</div>
          <div class="muted small">Plasma (9745) • Multi-Token • Smart Wallet Control</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div id="walletAddress" class="muted small">Not connected</div>
        <button id="connectBtn" class="px-3 py-2 rounded-lg btn-grad">Connect Wallet</button>
      </div>
    </header>

    <nav class="flex gap-2 mb-4">
      <button id="tabMy" class="px-4 py-2 text-gray-300">My Pools</button>
      <button id="tabRealTrade" class="px-4 py-2 text-blue-400 border-b-2 border-blue-400">Advanced Auto Trade</button>
    </nav>

    <!-- Advanced Auto Trading -->
    <section id="viewRealTrade">
      <div class="grid grid-cols-1 xl:grid-cols-4 gap-4">
        <!-- Trading Configuration -->
        <div class="card xl:col-span-2">
          <div class="font-semibold mb-4">Advanced Trading Configuration</div>
          
          <!-- Custom Token Input -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="small muted">Base Token (Buy/Sell)</label>
              <div class="flex gap-2">
                <input id="customBaseToken" placeholder="0x..." class="flex-1 bg-transparent border rounded-lg px-3 py-2 mt-1"/>
                <button id="btnAddCustomToken" class="px-3 py-2 mt-1 rounded-lg bg-purple-600">Add</button>
              </div>
              <div class="muted small mt-1">Current: <span id="currentBaseToken">COZY (0x06e2...df5c)</span></div>
            </div>
            
            <div>
              <label class="small muted">Quote Token (Pay/Receive)</label>
              <select id="quoteToken" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1">
                <option value="XPL_NATIVE">XPL (Native)</option>
                <option value="0x59cdd876f3b8a4e81ecb467078ea009f80052fa2">CRY BABY</option>
                <option value="CUSTOM">Custom Address...</option>
              </select>
              <input id="customQuoteToken" placeholder="Custom quote token 0x..." class="w-full bg-transparent border rounded-lg px-3 py-2 mt-2 hidden"/>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="small muted">Trade Mode</label>
              <select id="tradeMode" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1">
                <option value="BUY_ONLY">Buy Only</option>
                <option value="SELL_ONLY">Sell Only</option>
                <option value="BUY_SELL">Buy & Sell (60/40)</option>
                <option value="RANDOM">Random (50/50)</option>
                <option value="AGGRESSIVE_BUY">Aggressive Buy (80/20)</option>
                <option value="AGGRESSIVE_SELL">Aggressive Sell (20/80)</option>
              </select>
            </div>
            
            <div>
              <label class="small muted">Trading Strategy</label>
              <select id="tradingStrategy" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1">
                <option value="SIMPLE">Simple Random</option>
                <option value="VOLUME_BASED">Volume Based</option>
                <option value="PRICE_BASED">Price Movement</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="small muted">Min Amount</label>
              <input id="minAmount" type="number" step="0.0001" value="0.001" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1"/>
            </div>
            
            <div>
              <label class="small muted">Max Amount</label>
              <input id="maxAmount" type="number" step="0.0001" value="0.01" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1"/>
            </div>
            
            <div>
              <label class="small muted">Interval (seconds)</label>
              <input id="tradeInterval" type="number" value="45" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1"/>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="small muted">Slippage (%)</label>
              <input id="slippage" type="number" value="5" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1"/>
            </div>
            
            <div>
              <label class="small muted">Gas Limit Multiplier</label>
              <input id="gasMultiplier" type="number" value="1.3" step="0.1" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1"/>
            </div>
          </div>

          <!-- Advanced Options -->
          <div class="bg-black bg-opacity-20 rounded-lg p-3 mb-4">
            <div class="font-medium mb-2">Advanced Options</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="chkMainWalletTrade" class="checkbox-custom" checked>
                Include Main Wallet in Trading
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="chkAutoApprove" class="checkbox-custom" checked>
                Auto-Approve New Tokens
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="chkSkipFailed" class="checkbox-custom" checked>
                Skip Failed Wallets
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="chkRandomAmounts" class="checkbox-custom" checked>
                Randomize Amounts
              </label>
            </div>
          </div>

          <div class="flex gap-3 mb-4">
            <button id="btnApproveTokens" class="flex-1 px-4 py-3 rounded-lg bg-yellow-600 font-semibold">Approve Current Tokens</button>
            <button id="btnCheckAllowances" class="flex-1 px-4 py-3 rounded-lg bg-purple-600 font-semibold">Check Allowances</button>
          </div>

          <div class="flex gap-3">
            <button id="btnStartRealTrade" class="flex-1 px-4 py-3 rounded-lg auto-buy font-semibold">Start Advanced Trading</button>
            <button id="btnStopRealTrade" class="flex-1 px-4 py-3 rounded-lg auto-sell font-semibold" disabled>Stop Trading</button>
            <button id="btnEmergencyStop" class="px-4 py-3 rounded-lg bg-red-600 font-semibold">EMERGENCY STOP</button>
          </div>
        </div>

        <!-- Wallet Management -->
        <div class="card xl:col-span-2">
          <div class="font-semibold mb-4">Smart Wallet Management</div>
          
          <div class="space-y-3 mb-4">
            <!-- Main Wallet with Toggle -->
            <div class="flex items-center justify-between p-3 bg-black bg-opacity-30 rounded-lg">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="chkMainWallet" class="checkbox-custom" checked>
                <div>
                  <div class="font-medium">Main Wallet</div>
                  <div class="muted small" id="mainWalletBalance">Balance: —</div>
                  <div class="muted small" id="mainWalletAllowance">Allowance: —</div>
                </div>
              </div>
              <div class="text-green-400 text-sm">Connected</div>
            </div>
            
            <!-- Bot Wallets -->
            <div id="botWalletsList" class="space-y-2">
              <!-- Bot wallets will be added here dynamically -->
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex gap-2">
              <button id="btnAddBotWallet" class="flex-1 px-3 py-2 rounded-lg border border-dashed border-gray-600 text-gray-400 hover:text-white">
                + Add Bot Wallet
              </button>
              <button id="btnToggleAllWallets" class="px-3 py-2 rounded-lg bg-blue-600">
                Toggle All
              </button>
            </div>
            
            <!-- Wallet Statistics -->
            <div class="grid grid-cols-3 gap-2 p-3 bg-black bg-opacity-20 rounded-lg">
              <div class="text-center">
                <div class="text-lg font-bold" id="activeWalletCount">1</div>
                <div class="muted text-xs">Active</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold" id="totalWalletCount">1</div>
                <div class="muted text-xs">Total</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold" id="readyWalletCount">0</div>
                <div class="muted text-xs">Ready</div>
              </div>
            </div>
            
            <div class="bg-yellow-900 bg-opacity-20 rounded-lg p-3">
              <div class="small text-yellow-400">
                💡 Uncheck wallets to exclude from trading. Green = Active, Red = Inactive
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trading Statistics -->
      <div class="card mt-4">
        <div class="font-semibold mb-4">Advanced Trading Statistics</div>
        
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
          <div class="text-center p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="text-2xl font-bold text-green-400" id="totalBuys">0</div>
            <div class="muted small">Total Buys</div>
          </div>
          
          <div class="text-center p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="text-2xl font-bold text-red-400" id="totalSells">0</div>
            <div class="muted small">Total Sells</div>
          </div>
          
          <div class="text-center p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="text-2xl font-bold text-blue-400" id="successfulTrades">0</div>
            <div class="muted small">Successful</div>
          </div>
          
          <div class="text-center p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="text-2xl font-bold text-yellow-400" id="failedTrades">0</div>
            <div class="muted small">Failed</div>
          </div>
          
          <div class="text-center p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="text-2xl font-bold text-purple-400" id="totalVolume">0</div>
            <div class="muted small">Volume</div>
          </div>
          
          <div class="text-center p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="text-2xl font-bold text-cyan-400" id="gasUsed">0</div>
            <div class="muted small">Gas Used</div>
          </div>
        </div>
      </div>

      <!-- System Status -->
      <div class="card mt-4">
        <div class="font-semibold mb-4">Advanced System Status</div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="small muted">Trading Status</div>
            <div id="tradingStatus" class="status-stopped font-semibold">Stopped</div>
          </div>
          <div class="p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="small muted">Current Pair</div>
            <div id="currentPair" class="font-semibold">—</div>
          </div>
          <div class="p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="small muted">Last Action</div>
            <div id="lastAction" class="font-semibold">—</div>
          </div>
          <div class="p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="small muted">Next Trade In</div>
            <div id="nextTradeCountdown" class="font-semibold">—</div>
          </div>
        </div>
      </div>

      <!-- Token Management -->
      <div class="card mt-4">
        <div class="font-semibold mb-4">Token Management</div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="small muted">Base Token</div>
            <div id="currentBaseInfo" class="font-semibold">COZY</div>
            <div class="muted small text-xs" id="currentBaseAddress">0x06e2...df5c</div>
          </div>
          <div class="p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="small muted">Quote Token</div>
            <div id="currentQuoteInfo" class="font-semibold">XPL</div>
            <div class="muted small text-xs" id="currentQuoteAddress">Native</div>
          </div>
          <div class="p-3 bg-black bg-opacity-20 rounded-lg">
            <div class="small muted">Pair Status</div>
            <div id="pairStatus" class="font-semibold text-yellow-400">Need Approval</div>
          </div>
        </div>
      </div>

      <!-- Live Trading Activity -->
      <div class="card mt-4">
        <div class="flex justify-between items-center mb-4">
          <div class="font-semibold">Live Trading Activity</div>
          <button id="btnClearLog" class="px-3 py-1 rounded-lg border border-gray-600 text-sm">Clear Log</button>
        </div>
        <div id="realActivityLog" class="max-h-80 overflow-y-auto space-y-2 small">
          <div class="text-center muted py-8">No trading activity yet. Add custom tokens and start trading!</div>
        </div>
      </div>

      <!-- Add Wallet Modal -->
      <div id="addWalletModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-900 rounded-lg p-6 w-full max-w-md">
          <div class="font-semibold mb-4">Add Bot Wallet</div>
          
          <div class="space-y-3">
            <div>
              <label class="small muted">Private Key</label>
              <input id="newWalletPrivateKey" type="password" placeholder="Enter private key" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1"/>
            </div>
            
            <div>
              <label class="small muted">Wallet Name (optional)</label>
              <input id="newWalletName" placeholder="Bot Wallet 1" class="w-full bg-transparent border rounded-lg px-3 py-2 mt-1"/>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button id="btnConfirmAddWallet" class="flex-1 px-3 py-2 rounded-lg btn-grad">Add Wallet</button>
              <button id="btnCancelAddWallet" class="flex-1 px-3 py-2 rounded-lg border muted">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ============================
  Config & Dependencies
   ============================ */
const RPC = 'https://plasma-mainnet.g.alchemy.com/v2/MuLXFm60Tsz3ntyrSC1O4';
const CHAIN_ID_HEX = '0x2611';
const ROUTER = '0x89E695B38610e78a77Fb310458Dfd855505AD239';
const FACTORY = '0xa252e44D3478CeBb1a3D59C9146CD860cb09Ec93';
const WXPL = '0x6100E367285b01F48D07953803A2d8dCA5D19873';
const SCAN_BASE = 'https://plasmascan.to/tx/';

// Default Token Addresses
const DEFAULT_TOKENS = {
  XPL: { symbol: 'XPL', address: 'XPL_NATIVE', decimals: 18 },
  COZY: { symbol: 'COZY', address: '0x06e2ef46662834f4e42dbf9ff9222b077c57df5c', decimals: 18 },
  CRY: { symbol: 'CRY BABY', address: '0x59cdd876f3b8a4e81ecb467078ea009f80052fa2', decimals: 18 }
};

const ERC20_ABI = [
  'function decimals() view returns (uint8)',
  'function symbol() view returns (string)',
  'function balanceOf(address) view returns (uint256)',
  'function approve(address spender,uint256 amount) returns (bool)',
  'function allowance(address owner,address spender) view returns (uint256)',
  'function transfer(address to, uint256 amount) returns (bool)'
];

const ROUTER_ABI = [
  'function swapExactETHForTokens(uint amountOutMin, address[] path, address to, uint deadline) payable returns (uint[] amounts)',
  'function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] path, address to, uint deadline) returns (uint[] amounts)',
  'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] path, address to, uint deadline) returns (uint[] amounts)',
  'function getAmountsOut(uint amountIn, address[] path) view returns (uint[] amounts)'
];

/* ============================
  Global Variables
   ============================ */
let ethersLib, provider, mainSigner, mainAccount;
let routerContract;
let realTradeInterval = null;
let countdownInterval = null;
let isRealTrading = false;

// Current trading pair
let currentTradingPair = {
  base: DEFAULT_TOKENS.COZY,
  quote: DEFAULT_TOKENS.XPL
};

// Trading statistics
let tradingStats = {
  totalBuys: 0,
  totalSells: 0,
  successfulTrades: 0,
  failedTrades: 0,
  totalVolume: 0,
  gasUsed: 0
};

// Wallet management
let botWallets = [];
const LS_BOT_WALLETS = 'cozy_advanced_bot_wallets';
const LS_CUSTOM_TOKENS = 'cozy_custom_tokens';

/* ============================
  DOM Elements
   ============================ */
const customBaseToken = document.getElementById('customBaseToken');
const btnAddCustomToken = document.getElementById('btnAddCustomToken');
const quoteToken = document.getElementById('quoteToken');
const customQuoteToken = document.getElementById('customQuoteToken');
const tradingStrategy = document.getElementById('tradingStrategy');
const chkMainWalletTrade = document.getElementById('chkMainWalletTrade');
const chkAutoApprove = document.getElementById('chkAutoApprove');
const chkSkipFailed = document.getElementById('chkSkipFailed');
const chkRandomAmounts = document.getElementById('chkRandomAmounts');
const chkMainWallet = document.getElementById('chkMainWallet');
const btnToggleAllWallets = document.getElementById('btnToggleAllWallets');
const activeWalletCount = document.getElementById('activeWalletCount');
const totalWalletCount = document.getElementById('totalWalletCount');
const readyWalletCount = document.getElementById('readyWalletCount');
const successfulTrades = document.getElementById('successfulTrades');
const failedTrades = document.getElementById('failedTrades');
const gasUsed = document.getElementById('gasUsed');
const currentPair = document.getElementById('currentPair');
const currentBaseInfo = document.getElementById('currentBaseInfo');
const currentBaseAddress = document.getElementById('currentBaseAddress');
const currentQuoteInfo = document.getElementById('currentQuoteInfo');
const currentQuoteAddress = document.getElementById('currentQuoteAddress');
const pairStatus = document.getElementById('pairStatus');
const btnClearLog = document.getElementById('btnClearLog');
const realActivityLog = document.getElementById('realActivityLog');
const lastAction = document.getElementById('lastAction');
const totalBuys = document.getElementById('totalBuys');
const totalSells = document.getElementById('totalSells');
const tradingStatus = document.getElementById('tradingStatus');
const btnStartRealTrade = document.getElementById('btnStartRealTrade');
const btnStopRealTrade = document.getElementById('btnStopRealTrade');
const btnEmergencyStop = document.getElementById('btnEmergencyStop');
const btnApproveTokens = document.getElementById('btnApproveTokens');
const btnCheckAllowances = document.getElementById('btnCheckAllowances');
const botWalletsList = document.getElementById('botWalletsList');
const btnAddBotWallet = document.getElementById('btnAddBotWallet');
const addWalletModal = document.getElementById('addWalletModal');
const newWalletPrivateKey = document.getElementById('newWalletPrivateKey');
const newWalletName = document.getElementById('newWalletName');
const btnConfirmAddWallet = document.getElementById('btnConfirmAddWallet');
const btnCancelAddWallet = document.getElementById('btnCancelAddWallet');
const mainWalletBalance = document.getElementById('mainWalletBalance');
const mainWalletAllowance = document.getElementById('mainWalletAllowance');

/* ============================
  Helper Functions - FIXED
   ============================ */
function loadLS(k, d) { 
  try { 
    const v = localStorage.getItem(k); 
    return v ? JSON.parse(v) : d;
  } catch(e) { 
    return d; 
  } 
}

function saveLS(k, v) { 
  try { 
    localStorage.setItem(k, JSON.stringify(v)); 
  } catch(e) {} 
}

function shortAddr(a) { 
  if(!a) return '-'; 
  return a.slice(0,4) + '...' + a.slice(-4); 
}

function addRealActivityLog(message, type = 'info') {
  const logEntry = document.createElement('div');
  const timestamp = new Date().toLocaleTimeString();
  const colors = {
    buy: 'text-green-400',
    sell: 'text-red-400',
    info: 'text-blue-400',
    error: 'text-yellow-400',
    success: 'text-green-400',
    warning: 'text-yellow-400'
  };
  
  logEntry.innerHTML = `
    <div class="flex justify-between items-center p-2 bg-black bg-opacity-20 rounded">
      <span class="${colors[type] || 'text-gray-400'}">${message}</span>
      <span class="muted text-xs">${timestamp}</span>
    </div>
  `;
  
  realActivityLog.insertBefore(logEntry, realActivityLog.firstChild);
  
  // Keep only last 50 entries
  if (realActivityLog.children.length > 50) {
    realActivityLog.removeChild(realActivityLog.lastChild);
  }
  
  // Update last action
  if (lastAction) {
    lastAction.textContent = message.substring(0, 50) + (message.length > 50 ? '...' : '');
  }
}

function updateTradingStats() {
  if (totalBuys) totalBuys.textContent = tradingStats.totalBuys;
  if (totalSells) totalSells.textContent = tradingStats.totalSells;
  if (successfulTrades) successfulTrades.textContent = tradingStats.successfulTrades;
  if (failedTrades) failedTrades.textContent = tradingStats.failedTrades;
  if (totalVolume) totalVolume.textContent = tradingStats.totalVolume.toFixed(4);
  if (gasUsed) gasUsed.textContent = tradingStats.gasUsed;
}

function updateTradingStatus(status, type = 'stopped') {
  if (tradingStatus) {
    tradingStatus.textContent = status;
    tradingStatus.className = `status-${type} font-semibold`;
  }
}

function updateCurrentPair() {
  if (currentPair) currentPair.textContent = `${currentTradingPair.base.symbol}/${currentTradingPair.quote.symbol}`;
  if (currentBaseInfo) currentBaseInfo.textContent = currentTradingPair.base.symbol;
  if (currentBaseAddress) currentBaseAddress.textContent = shortAddr(currentTradingPair.base.address);
  if (currentQuoteInfo) currentQuoteInfo.textContent = currentTradingPair.quote.symbol;
  if (currentQuoteAddress) {
    currentQuoteAddress.textContent = currentTradingPair.quote.address === 'XPL_NATIVE' ? 'Native' : shortAddr(currentTradingPair.quote.address);
  }
}

/* ============================
  Token Management System - FIXED
   ============================ */
async function addCustomToken() {
  const tokenAddress = customBaseToken.value.trim();
  
  if (!tokenAddress) {
    alert('Please enter a token address');
    return;
  }
  
  if (!ethersLib.utils.isAddress(tokenAddress)) {
    alert('Please enter a valid token address');
    return;
  }
  
  try {
    addRealActivityLog(`Adding custom token: ${shortAddr(tokenAddress)}...`, 'info');
    
    // Get token info
    const tokenContract = new ethersLib.Contract(tokenAddress, ERC20_ABI, provider);
    const [symbol, decimals] = await Promise.all([
      tokenContract.symbol().catch(() => 'UNKNOWN'),
      tokenContract.decimals().catch(() => 18)
    ]);
    
    // Update current trading pair
    currentTradingPair.base = {
      symbol: symbol,
      address: tokenAddress,
      decimals: decimals
    };
    
    // Update UI
    updateCurrentPair();
    customBaseToken.value = '';
    
    addRealActivityLog(`✅ Added token: ${symbol} (${decimals} decimals)`, 'success');
    
    // Auto-approve if enabled
    if (chkAutoApprove && chkAutoApprove.checked) {
      setTimeout(() => approveAllTokens(), 1000);
    } else {
      checkAllAllowances();
    }
    
  } catch (error) {
    console.error('Error adding token:', error);
    addRealActivityLog(`❌ Failed to add token: ${error.message}`, 'error');
  }
}

function handleQuoteTokenChange() {
  const selectedValue = quoteToken.value;
  
  if (selectedValue === 'CUSTOM') {
    customQuoteToken.classList.remove('hidden');
    customQuoteToken.focus();
  } else {
    customQuoteToken.classList.add('hidden');
    
    // Update current trading pair
    if (selectedValue === 'XPL_NATIVE') {
      currentTradingPair.quote = DEFAULT_TOKENS.XPL;
    } else if (selectedValue === DEFAULT_TOKENS.CRY.address) {
      currentTradingPair.quote = DEFAULT_TOKENS.CRY;
    }
    
    updateCurrentPair();
    checkAllAllowances();
  }
}

async function addCustomQuoteToken() {
  const tokenAddress = customQuoteToken.value.trim();
  
  if (!tokenAddress) {
    alert('Please enter a token address');
    return;
  }
  
  if (!ethersLib.utils.isAddress(tokenAddress)) {
    alert('Please enter a valid token address');
    return;
  }
  
  try {
    addRealActivityLog(`Adding custom quote token: ${shortAddr(tokenAddress)}...`, 'info');
    
    // Get token info
    const tokenContract = new ethersLib.Contract(tokenAddress, ERC20_ABI, provider);
    const [symbol, decimals] = await Promise.all([
      tokenContract.symbol().catch(() => 'UNKNOWN'),
      tokenContract.decimals().catch(() => 18)
    ]);
    
    // Update current trading pair
    currentTradingPair.quote = {
      symbol: symbol,
      address: tokenAddress,
      decimals: decimals
    };
    
    updateCurrentPair();
    customQuoteToken.value = '';
    quoteToken.value = 'CUSTOM';
    
    addRealActivityLog(`✅ Added quote token: ${symbol}`, 'success');
    
    // Auto-approve if enabled
    if (chkAutoApprove && chkAutoApprove.checked) {
      setTimeout(() => approveAllTokens(), 1000);
    } else {
      checkAllAllowances();
    }
    
  } catch (error) {
    console.error('Error adding quote token:', error);
    addRealActivityLog(`❌ Failed to add quote token: ${error.message}`, 'error');
  }
}

/* ============================
  Enhanced Wallet Management - FIXED
   ============================ */
function loadBotWallets() {
  const savedWallets = loadLS(LS_BOT_WALLETS, []);
  botWallets = savedWallets.map(w => ({
    ...w,
    active: w.active !== undefined ? w.active : true
  }));
  renderBotWallets();
}

function saveBotWallets() {
  const walletsToSave = botWallets.map(w => ({
    address: w.address,
    name: w.name,
    active: w.active
  }));
  saveLS(LS_BOT_WALLETS, walletsToSave);
}

function renderBotWallets() {
  if (!botWalletsList) return;
  
  botWalletsList.innerHTML = '';
  
  botWallets.forEach((wallet, index) => {
    const walletEl = document.createElement('div');
    const isActive = wallet.active;
    
    walletEl.className = `flex items-center justify-between p-3 rounded-lg ${isActive ? 'bg-black bg-opacity-30' : 'bg-red-900 bg-opacity-20'}`;
    walletEl.innerHTML = `
      <div class="flex items-center gap-3">
        <input type="checkbox" class="checkbox-custom wallet-toggle" data-index="${index}" ${isActive ? 'checked' : ''}>
        <div>
          <div class="font-medium">${wallet.name || `Bot ${index + 1}`}</div>
          <div class="muted small">${shortAddr(wallet.address)} • Balance: <span id="botBalance${index}">—</span></div>
          <div class="muted small">Allowance: <span id="botAllowance${index}">—</span></div>
        </div>
      </div>
      <div class="flex gap-2">
        <button class="remove-wallet text-red-400 text-xs px-2 py-1 border border-red-400 rounded" data-index="${index}">Remove</button>
      </div>
    `;
    botWalletsList.appendChild(walletEl);
  });
  
  // Add event listeners
  document.querySelectorAll('.wallet-toggle').forEach(btn => {
    btn.addEventListener('change', (e) => {
      const index = parseInt(e.target.getAttribute('data-index'));
      toggleBotWallet(index, e.target.checked);
    });
  });
  
  document.querySelectorAll('.remove-wallet').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const index = parseInt(e.target.getAttribute('data-index'));
      removeBotWallet(index);
    });
  });
  
  updateWalletStats();
  updateWalletBalances();
  checkAllAllowances();
}

function toggleBotWallet(index, active) {
  if (botWallets[index]) {
    botWallets[index].active = active;
    saveBotWallets();
    renderBotWallets();
    addRealActivityLog(`${active ? '✅ Activated' : '🔴 Deactivated'} ${botWallets[index].name || `Bot ${index + 1}`}`, 'info');
  }
}

function toggleAllWallets() {
  const allActive = botWallets.every(w => w.active);
  const newState = !allActive;
  
  botWallets.forEach(wallet => {
    wallet.active = newState;
  });
  
  saveBotWallets();
  renderBotWallets();
  addRealActivityLog(`${newState ? '✅ Activated' : '🔴 Deactivated'} all bot wallets`, 'info');
}

function updateWalletStats() {
  const totalWallets = 1 + botWallets.length;
  const activeWalletsCount = (chkMainWallet && chkMainWallet.checked ? 1 : 0) + botWallets.filter(w => w.active).length;
  
  if (activeWalletCount) activeWalletCount.textContent = activeWalletsCount;
  if (totalWalletCount) totalWalletCount.textContent = totalWallets;
  if (readyWalletCount) readyWalletCount.textContent = 0;
  
  tradingStats.activeWallets = activeWalletsCount;
  updateTradingStats();
}

/* ============================
  Wallet Connection - FIXED
   ============================ */
async function connectMainWallet() {
  try {
    if (typeof window.ethereum !== 'undefined') {
      // Request account access
      const accounts = await window.ethereum.request({ 
        method: 'eth_requestAccounts' 
      });
      
      mainAccount = accounts[0];
      
      // Create provider and signer
      provider = new ethersLib.providers.Web3Provider(window.ethereum);
      mainSigner = provider.getSigner();
      
      // Update UI
      document.getElementById('walletAddress').textContent = shortAddr(mainAccount);
      document.getElementById('connectBtn').textContent = 'Connected';
      document.getElementById('connectBtn').classList.add('wallet-active');
      
      // Initialize router contract
      routerContract = new ethersLib.Contract(ROUTER, ROUTER_ABI, mainSigner);
      
      addRealActivityLog(`✅ Wallet connected: ${shortAddr(mainAccount)}`, 'success');
      
      // Update wallet info
      updateMainWalletInfo();
      
    } else {
      throw new Error('MetaMask or other Web3 wallet not found');
    }
  } catch (error) {
    console.error('Wallet connection error:', error);
    addRealActivityLog(`❌ Failed to connect wallet: ${error.message}`, 'error');
    alert('Failed to connect wallet. Please make sure you have MetaMask installed.');
  }
}

async function updateMainWalletInfo() {
  if (!mainSigner) return;
  
  try {
    // Get balance
    const balance = await provider.getBalance(mainAccount);
    const balanceInEth = ethersLib.utils.formatEther(balance);
    
    if (mainWalletBalance) {
      mainWalletBalance.textContent = `Balance: ${parseFloat(balanceInEth).toFixed(4)} XPL`;
    }
    
    // Check allowance if base token is not native
    if (currentTradingPair.base.address !== 'XPL_NATIVE') {
      const tokenContract = new ethersLib.Contract(currentTradingPair.base.address, ERC20_ABI, mainSigner);
      const allowance = await tokenContract.allowance(mainAccount, ROUTER);
      const allowanceFormatted = ethersLib.utils.formatUnits(allowance, currentTradingPair.base.decimals);
      
      if (mainWalletAllowance) {
        mainWalletAllowance.textContent = `Allowance: ${parseFloat(allowanceFormatted).toFixed(4)}`;
      }
    } else {
      if (mainWalletAllowance) {
        mainWalletAllowance.textContent = `Allowance: Native (Auto)`;
      }
    }
  } catch (error) {
    console.error('Error updating wallet info:', error);
  }
}

/* ============================
  Trading Functions - FIXED
   ============================ */
async function startRealTrading() {
  if (isRealTrading) return;
  
  try {
    const interval = parseInt(tradeInterval.value) || 45;
    
    isRealTrading = true;
    btnStartRealTrade.disabled = true;
    btnStopRealTrade.disabled = false;
    
    updateTradingStatus('Running', 'running');
    addRealActivityLog(`🚀 Advanced trading started - Interval: ${interval}s`, 'success');
    
    // Execute first trade immediately
    executeRealTrade();
    
    // Set up interval for subsequent trades
    realTradeInterval = setInterval(() => {
      if (isRealTrading) {
        executeRealTrade();
      }
    }, interval * 1000);
    
  } catch (error) {
    console.error('Error starting trading:', error);
    addRealActivityLog(`❌ Failed to start trading: ${error.message}`, 'error');
    stopRealTrading();
  }
}

function stopRealTrading() {
  isRealTrading = false;
  
  if (realTradeInterval) {
    clearInterval(realTradeInterval);
    realTradeInterval = null;
  }
  
  btnStartRealTrade.disabled = false;
  btnStopRealTrade.disabled = true;
  
  updateTradingStatus('Stopped', 'stopped');
  addRealActivityLog('🛑 Advanced trading stopped', 'warning');
}

function emergencyStop() {
  stopRealTrading();
  addRealActivityLog('🚨 EMERGENCY STOP - All trading halted', 'error');
}

/* ============================
  Token Approval - FIXED
   ============================ */
async function approveAllTokens() {
  try {
    addRealActivityLog('Approving tokens for all active wallets...', 'info');
    
    // Approve for main wallet if enabled
    if (chkMainWallet && chkMainWallet.checked && mainSigner) {
      await approveWalletTokens(mainSigner, 'Main Wallet');
    }
    
    // Approve for bot wallets
    for (let i = 0; i < botWallets.length; i++) {
      if (botWallets[i].active) {
        const walletSigner = new ethersLib.Wallet(botWallets[i].privateKey, provider);
        await approveWalletTokens(walletSigner, botWallets[i].name || `Bot ${i + 1}`);
      }
    }
    
    addRealActivityLog('✅ Token approval completed for all wallets', 'success');
    checkAllAllowances();
    
  } catch (error) {
    console.error('Approval error:', error);
    addRealActivityLog(`❌ Approval failed: ${error.message}`, 'error');
  }
}

async function approveWalletTokens(signer, walletName) {
  try {
    if (currentTradingPair.base.address === 'XPL_NATIVE') {
      addRealActivityLog(`✅ ${walletName}: Native token (auto-approved)`, 'success');
      return;
    }
    
    const tokenContract = new ethersLib.Contract(currentTradingPair.base.address, ERC20_ABI, signer);
    const approveAmount = ethersLib.constants.MaxUint256;
    
    const tx = await tokenContract.approve(ROUTER, approveAmount);
    addRealActivityLog(`⏳ ${walletName}: Approval pending...`, 'info');
    
    await tx.wait();
    addRealActivityLog(`✅ ${walletName}: Tokens approved`, 'success');
    
  } catch (error) {
    addRealActivityLog(`❌ ${walletName}: Approval failed - ${error.message}`, 'error');
    throw error;
  }
}

async function checkAllAllowances() {
  // Implementation for checking allowances
  addRealActivityLog('Checking token allowances...', 'info');
  // Add actual implementation here
}

/* ============================
  Bot Wallet Management - FIXED
   ============================ */
function confirmAddWallet() {
  const privateKey = newWalletPrivateKey.value.trim();
  const name = newWalletName.value.trim() || `Bot ${botWallets.length + 1}`;
  
  if (!privateKey) {
    alert('Please enter a private key');
    return;
  }
  
  try {
    // Validate private key
    const wallet = new ethersLib.Wallet(privateKey);
    
    // Add to bot wallets
    botWallets.push({
      address: wallet.address,
      privateKey: privateKey,
      name: name,
      active: true
    });
    
    saveBotWallets();
    renderBotWallets();
    
    // Clear and close modal
    newWalletPrivateKey.value = '';
    newWalletName.value = '';
    addWalletModal.classList.add('hidden');
    
    addRealActivityLog(`✅ Added bot wallet: ${name} (${shortAddr(wallet.address)})`, 'success');
    
  } catch (error) {
    alert('Invalid private key. Please check and try again.');
    console.error('Error adding wallet:', error);
  }
}

function removeBotWallet(index) {
  if (botWallets[index]) {
    const wallet = botWallets[index];
    botWallets.splice(index, 1);
    saveBotWallets();
    renderBotWallets();
    addRealActivityLog(`🗑️ Removed bot wallet: ${wallet.name || `Bot ${index + 1}`}`, 'warning');
  }
}

async function updateWalletBalances() {
  // Implementation for updating wallet balances
  // This would update balance displays for all wallets
}

/* ============================
  Main Initialization - FIXED
   ============================ */
async function init() {
  try {
    // Use global ethers from CDN
    ethersLib = window.ethers;
    
    // Create provider
    provider = new ethersLib.providers.JsonRpcProvider(RPC);
    routerContract = new ethersLib.Contract(ROUTER, ROUTER_ABI, provider);
    
    // Load bot wallets and setup
    loadBotWallets();
    updateCurrentPair();
    
    // Bind UI events
    bindUI();
    
    addRealActivityLog('Advanced trading system initialized! Add custom tokens to start.', 'info');
    updateTradingStatus('Ready - Add Tokens', 'warning');
    
  } catch (error) {
    console.error('Initialization error:', error);
    addRealActivityLog(`Initialization failed: ${error.message}`, 'error');
  }
}

function bindUI() {
  // Connect wallet
  document.getElementById('connectBtn').addEventListener('click', connectMainWallet);
  
  // Token management
  if (btnAddCustomToken) btnAddCustomToken.addEventListener('click', addCustomToken);
  if (quoteToken) quoteToken.addEventListener('change', handleQuoteTokenChange);
  if (customQuoteToken) {
    customQuoteToken.addEventListener('blur', addCustomQuoteToken);
    customQuoteToken.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addCustomQuoteToken();
    });
  }
  
  // Wallet controls
  if (chkMainWallet) chkMainWallet.addEventListener('change', updateWalletStats);
  if (chkMainWalletTrade) chkMainWalletTrade.addEventListener('change', updateWalletStats);
  if (btnToggleAllWallets) btnToggleAllWallets.addEventListener('click', toggleAllWallets);
  
  // Trading controls
  if (btnApproveTokens) btnApproveTokens.addEventListener('click', approveAllTokens);
  if (btnCheckAllowances) btnCheckAllowances.addEventListener('click', checkAllAllowances);
  if (btnStartRealTrade) btnStartRealTrade.addEventListener('click', startRealTrading);
  if (btnStopRealTrade) btnStopRealTrade.addEventListener('click', stopRealTrading);
  if (btnEmergencyStop) btnEmergencyStop.addEventListener('click', emergencyStop);
  if (btnClearLog) btnClearLog.addEventListener('click', () => {
    realActivityLog.innerHTML = '<div class="text-center muted py-8">Log cleared</div>';
    addRealActivityLog('Log cleared by user', 'info');
  });
  
  // Wallet management
  if (btnAddBotWallet) btnAddBotWallet.addEventListener('click', () => addWalletModal.classList.remove('hidden'));
  if (btnConfirmAddWallet) btnConfirmAddWallet.addEventListener('click', confirmAddWallet);
  if (btnCancelAddWallet) btnCancelAddWallet.addEventListener('click', () => addWalletModal.classList.add('hidden'));
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
